<?xml version="1.0" encoding="utf-8"?>
<s:Group xmlns:fx="http://ns.adobe.com/mxml/2009"
		 xmlns:s="library://ns.adobe.com/flex/spark"
		 xmlns:mx="library://ns.adobe.com/flex/mx"
		 xmlns:components="com.hillelcoren.components.*"
		 xmlns:controls="com.adobe.flex.extras.controls.*"
		 width="694" height="380" initialize="group1_initializeHandler(event)">
	<fx:Script>
		<![CDATA[
			import flexunit.utils.ArrayList;
			
			import mx.collections.ArrayCollection;
			import mx.controls.Alert;
			import mx.events.CloseEvent;
			import mx.events.FlexEvent;
			import mx.rpc.events.FaultEvent;
			import mx.rpc.events.ResultEvent;
			
			import org.flexunit.internals.matchers.Each;
			
			import spark.events.ListEvent;
			[Bindable]
				private var xmlproduct:XMLList;
			
			[Bindable]
				private var dp:Array=[];
			
			protected function operation1_faultHandler(event:FaultEvent):void
			{
				Alert.show("ERROR "+event.fault.toString());
				
			}
			
			protected function operation1_resultHandler(event:ResultEvent):void
			{
				xmlproduct=new XMLList(event.result);
				
				
				cmbproduct.dataProvider=productlist;
				Alert.show(xmlproduct.toString());
			
				
				
			}
			
			protected function group1_initializeHandler(event:FlexEvent):void
			{
				productosWs.searchAllProductos();
				cmbproduct.addEventListener(KeyboardEvent.KEY_UP,transferirFocus);
				txtpreciop.addEventListener(KeyboardEvent.KEY_UP,transferirFocus);
				mskcantidad.addEventListener(KeyboardEvent.KEY_UP,transferirFocus);
				cmbproduct.selectedItemId=1;
			}
			//--------------------------------------------------------------------------------------
			private function addadglistpedprod(codigoId:String,txtprecio:String,cantidad:String,descripcion:String):void{
				var subtot:Number;
				var b:Boolean=false;
				//var cant:int=0;
				subtot=Number(Number(Number(Number(txtprecio).toFixed(2))*Number(cantidad)).toFixed(2));
				
				
				if(dp.length==0)
					dp=[{id:codigoId,name:descripcion,countt:cantidad,price:txtprecio,subtotal:subtot}];
				else{
					
						for(var i:int=0;i<dp.length;i++){	
					//for (var index in dp){
								
							if(dp[i].name==descripcion){
								dp[i].countt=int(dp[i].countt)+int(cantidad);
								//cant=int(dp[i].countt);
								//cant=cant+int(cantidad);
								//dp[i].countt=cant;
								dp[i].subtotal=dp[i].subtotal+subtot;
								b=true;
							
							}
						}
					if(!b)					
						dp.push({id:codigoId,name:descripcion,countt:cantidad,price:txtprecio,subtotal:subtot});
						
					}
			
			
				arrayDg.source=dp;
				arrayDg.refresh();
				
				

					
				
				
					
				
				
				//arrayDg=[{id:codigoId,name:descripcion,countt:cantidad,price:txtprecio}];
				
				adglistpedprod.dataProvider=arrayDg;
			
			}
			//--------------------------------------------------------------------------------------
			private function transferirFocus(KeyPress:KeyboardEvent):void{
				
				if(KeyPress.keyCode==Keyboard.ENTER){
					if(KeyPress.currentTarget.toString().indexOf("cmbproduct")!=-1){
							focusManager.setFocus(txtpreciop);
							txtpreciop.text=cmbproduct.selectedItem.precio;
					
					}
					if(KeyPress.currentTarget.toString().indexOf("mskcantidad")!=-1){
						
						addadglistpedprod(cmbproduct.selectedItem.id,txtpreciop.text,mskcantidad.text,cmbproduct.selectedItem.descripcion);
					
					}
					if(KeyPress.currentTarget.toString().indexOf("txtpreciop")!=-1)
						focusManager.setFocus(mskcantidad);
						
				
				}
			
			
			}
			//---------------------------------------------------------------------------------
			
			//---------------------------------------------------------------------------------------
			protected function adglistpedprod_itemDoubleClickHandler(event:ListEvent):void
			{
				if (String("")!="undefined")
					Alert.show("SEGURO DE REMOVER ELEMENTO ", "",
						Alert.YES | Alert.CANCEL , this,
						removerElemento, null,  Alert.YES );
				
			}
			//---------------------------------------------------------------------------------------
			protected function removerElemento(eventObj:CloseEvent):void{
				if (eventObj.detail==Alert.YES) {
					var pos:int=-1;
					
					var idProduct:String=adglistpedprod.selectedItem.id;
					for (var i:int=0;i<arrayDg.length&&pos==-1;i++){
						var prod:String =arrayDg.getItemAt(i).id;
						if (idProduct==prod) pos= i;
						
					}
					
					if (pos!=-1) arrayDg.removeItemAt(pos);
					arrayDg.refresh();
				}
				
				
			}
			//-------------------------------------------------------------------------------------
			
		]]>
	</fx:Script>
	<fx:Declarations>
		<!-- Place non-visual elements (e.g., services, value objects) here -->
		<s:WebService id="productosWs" wsdl="http://localhost:8080/ServiceProductos/ProductosWs?wsdl"
					  showBusyCursor="true">
			<s:operation name="searchAllProductos"
						 fault="operation1_faultHandler(event)"
						 result="operation1_resultHandler(event)">
				
			</s:operation>
		</s:WebService>
		<s:XMLListCollection id="productlist" source="{xmlproduct.producto}"/>
		<s:ArrayCollection id="arrayDg"/>
	</fx:Declarations>
	<s:Label x="54" y="37" text="Producto:"/>
	<s:Label x="55" y="75" text="Precio: $"/>
	<s:TextInput id="txtpreciop" x="109" y="65"/>
	<s:Label x="55" y="116" text="Cantidad:"/>
	<controls:MaskedTextInput id="mskcantidad" x="111" y="106" width="55" restrict="0-9" maxChars="3"/>
	<mx:AdvancedDataGrid id="adglistpedprod" x="23" y="155" width="645" height="195"
						 designViewDataType="flat" rowCount="8" itemDoubleClick="adglistpedprod_itemDoubleClickHandler(event)">
		<mx:columns>
			<mx:AdvancedDataGridColumn dataField="id"  headerText="Codigo" width="40"/>
			<mx:AdvancedDataGridColumn dataField="name" headerText="Descripcion" width="80"/>
			<mx:AdvancedDataGridColumn dataField="countt" headerText="Cantidad" width="30" editable="true"
									   />
			<mx:AdvancedDataGridColumn dataField="price" headerText="Precio" width="40" editable="true" e/>
			<mx:AdvancedDataGridColumn dataField="subtotal" headerText="SubTotal" width="50" color="red"/>
		</mx:columns>
	</mx:AdvancedDataGrid>
	<components:AutoComplete id="cmbproduct" x="109" y="26"
							 matchType="beginning"
							 labelField="descripcion"
							 allowDuplicates="false"
							 dropDownRowCount="10">
	</components:AutoComplete>
</s:Group>
